#pragma once

#include "types.h"

struct PpuRegisters
{
	u16 v;
	u16 t;
	u8 x;
	u8 w;
};

struct Ppu
{
	int scanline = 0;
	int cycles = 0;
	int pixel = 0;
	int totalcycles = 0;

	bool nmi = false;
	bool frame_ready = false;

	void step(int num);
	void ppuctrl(u8 v);
	void ppumask(u8 v);
	u8 ppustatus();
	void oamaddrwrite(u8 v);
	void oamdatawrite(u8 v);
	void scrollwrite(u8 v);
	void addrwrite(u8 v);
	void datawrite(u8 v);
	u8 dataread();
	void reset();

	u8 ppuoamdma = 0;

private:
	void render_pixels();
	void render_sprites(u8 frontback);
	void set_vblank();
	void clear_vblank();
	void set_sprite_zero();
	void clear_sprite_zero();
	int get_attr_index(int x, int y, int attrib);
	void x_increment();
	void y_increment();

	u8 ppu_dummy2007 = 0;
	u8 fine_x = 0;
	u8 fine_y = 0;

	u8 tile_shift = 0;

	u8 scroll_x = 0;
	u8 scroll_y = 0;

	u16 nametableaddr = 0;
	u16 patternaddr = 0;

	bool spritesize = false;
	u8 vramaddrincrease = 1;

	bool background_on = false;
	bool sprite_render = false;

	u8 ppu2000 = 0;
	u8 ppu2001 = 0;
	u8 ppu2002 = 0;
	u8 ppu2003 = 0;
	u8 ppu2004 = 0;
	u8 ppu2005 = 0;
	u8 ppu2006 = 0;
	u8 ppu2007 = 0;

	u8 tile_id = 0;
	u8 tile_att = 0;
	u8 tile_lo = 0;
	u8 tile_hi = 0;

	u8 sp0data[256 * 240 * 4];

	u32 palettes[192 / 3];

	u8 palbuffer[192] =
	{
		0x61,0x61,0x61,0x00,0x00,0x88,0x1F,0x0D,0x99,0x37,0x13,0x79,0x56,0x12,0x60,0x5D,
		0x00,0x10,0x52,0x0E,0x00,0x3A,0x23,0x08,0x21,0x35,0x0C,0x0D,0x41,0x0E,0x17,0x44,
		0x17,0x00,0x3A,0x1F,0x00,0x2F,0x57,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xAA,0xAA,0xAA,0x0D,0x4D,0xC4,0x4B,0x24,0xDE,0x69,0x12,0xCF,0x90,0x14,0xAD,0x9D,
		0x1C,0x48,0x92,0x34,0x04,0x73,0x50,0x05,0x5D,0x69,0x13,0x16,0x7A,0x11,0x13,0x80,
		0x08,0x12,0x76,0x49,0x1C,0x66,0x91,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xFC,0xFC,0xFC,0x63,0x9A,0xFC,0x8A,0x7E,0xFC,0xB0,0x6A,0xFC,0xDD,0x6D,0xF2,0xE7,
		0x71,0xAB,0xE3,0x86,0x58,0xCC,0x9E,0x22,0xA8,0xB1,0x00,0x72,0xC1,0x00,0x5A,0xCD,
		0x4E,0x34,0xC2,0x8E,0x4F,0xBE,0xCE,0x42,0x42,0x42,0x00,0x00,0x00,0x00,0x00,0x00,
		0xFC,0xFC,0xFC,0xBE,0xD4,0xFC,0xCA,0xCA,0xFC,0xD9,0xC4,0xFC,0xEC,0xC1,0xFC,0xFA,
		0xC3,0xE7,0xF7,0xCE,0xC3,0xE2,0xCD,0xA7,0xDA,0xDB,0x9C,0xC8,0xE3,0x9E,0xBF,0xE5,
		0xB8,0xB2,0xEB,0xC8,0xB7,0xE5,0xEB,0xAC,0xAC,0xAC,0x00,0x00,0x00,0x00,0x00,0x00
	};
};

extern Ppu ppu;
extern PpuRegisters preg;